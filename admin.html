<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Rural Health Triage</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid;
        }

        .stat-card.red {
            border-left-color: #f44336;
        }

        .stat-card.yellow {
            border-left-color: #ffc107;
        }

        .stat-card.green {
            border-left-color: #4caf50;
        }

        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card.red .stat-number {
            color: #f44336;
        }

        .stat-card.yellow .stat-number {
            color: #ffc107;
        }

        .stat-card.green .stat-number {
            color: #4caf50;
        }

        .stat-label {
            font-size: 12px;
            color: #999;
        }

        .section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .section h2 {
            margin-bottom: 20px;
            color: #333;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }

        .case-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .case-item {
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid;
            background: #fafafa;
            transition: all 0.3s ease;
        }

        .case-item:hover {
            background: #f0f0f0;
            transform: translateX(5px);
        }

        .case-item.red {
            border-left-color: #f44336;
            background: #ffebee;
        }

        .case-item.yellow {
            border-left-color: #ffc107;
            background: #fff9e6;
        }

        .case-item.green {
            border-left-color: #4caf50;
            background: #e8f5e9;
        }

        .case-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .case-id {
            font-weight: bold;
            font-size: 14px;
        }

        .case-time {
            font-size: 12px;
            color: #666;
        }

        .case-severity {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .case-severity.red {
            background: #f44336;
            color: white;
        }

        .case-severity.yellow {
            background: #ffc107;
            color: #333;
        }

        .case-severity.green {
            background: #4caf50;
            color: white;
        }

        .case-details {
            font-size: 14px;
            color: #555;
            line-height: 1.6;
        }

        .medicine-usage {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .medicine-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }

        .medicine-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .medicine-count {
            font-size: 24px;
            color: #667eea;
            font-weight: bold;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 20px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .filter-btn:hover {
            background: #f0f0f0;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .chart-container h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 18px;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ“Š Admin Dashboard</h1>
        <p>Rural Health Triage System - Real-time Monitoring</p>
    </div>

    <div class="stats-grid">
        <div class="stat-card red">
            <h3>Emergency Cases</h3>
            <div class="stat-number" id="redCount">12</div>
            <div class="stat-label">Last 24 hours</div>
        </div>
        <div class="stat-card yellow">
            <h3>Doctor Reviews</h3>
            <div class="stat-number" id="yellowCount">28</div>
            <div class="stat-label">Pending + Completed</div>
        </div>
        <div class="stat-card green">
            <h3>Local Treatments</h3>
            <div class="stat-number" id="greenCount">145</div>
            <div class="stat-label">Successfully managed</div>
        </div>
        <div class="stat-card">
            <h3>Total Cases</h3>
            <div class="stat-number" style="color: #667eea;" id="totalCount">185</div>
            <div class="stat-label">This week</div>
        </div>
    </div>

    <div class="charts-grid">
        <div class="chart-container">
            <h3>ðŸ“ˆ Cases Per Day (Last 7 Days)</h3>
            <div class="chart-wrapper">
                <canvas id="casesPerDayChart"></canvas>
            </div>
        </div>
        <div class="chart-container">
            <h3>ðŸ“Š Category Distribution</h3>
            <div class="chart-wrapper">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>
        <div class="chart-container" style="grid-column: 1 / -1;">
            <h3>ðŸ’Š Medicine Consumption (Total Uses)</h3>
            <div class="chart-wrapper">
                <canvas id="medicineChart"></canvas>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>ðŸ“‹ Recent Cases</h2>
        <div class="filter-buttons">
            <button class="filter-btn active" onclick="filterCases('all')">All Cases</button>
            <button class="filter-btn" onclick="filterCases('red')">ðŸ”´ Emergency</button>
            <button class="filter-btn" onclick="filterCases('yellow')">ðŸŸ¡ Doctor Review</button>
            <button class="filter-btn" onclick="filterCases('green')">ðŸŸ¢ Local Care</button>
        </div>
        <div class="case-list" id="caseList">
            <!-- Cases will be populated here -->
        </div>
    </div>

    <script>
        let casesPerDayChart, categoryChart, medicineChart;
        let currentFilter = 'all';
        let analyticsData = null;

        // Fetch analytics data from server
        async function fetchAnalytics() {
            try {
                const response = await fetch('/api/analytics');
                analyticsData = await response.json();
                
                updateStats();
                updateCharts();
                renderRecentCases();
            } catch (error) {
                console.error('Error fetching analytics:', error);
            }
        }

        // Update statistics cards
        function updateStats() {
            if (!analyticsData) return;

            document.getElementById('redCount').textContent = analyticsData.categoryDistribution.RED;
            document.getElementById('yellowCount').textContent = analyticsData.categoryDistribution.YELLOW;
            document.getElementById('greenCount').textContent = analyticsData.categoryDistribution.GREEN;
            document.getElementById('totalCount').textContent = analyticsData.totalCases;
        }

        // Update all charts
        function updateCharts() {
            if (!analyticsData) return;

            updateCasesPerDayChart();
            updateCategoryChart();
            updateMedicineChart();
        }

        // Cases Per Day Chart
        function updateCasesPerDayChart() {
            const ctx = document.getElementById('casesPerDayChart').getContext('2d');
            
            const dates = Object.keys(analyticsData.casesPerDay).sort();
            const counts = dates.map(date => analyticsData.casesPerDay[date]);
            
            // Format dates for display (MM/DD)
            const labels = dates.map(date => {
                const d = new Date(date);
                return `${d.getMonth() + 1}/${d.getDate()}`;
            });

            if (casesPerDayChart) {
                casesPerDayChart.destroy();
            }

            casesPerDayChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cases',
                        data: counts,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#667eea',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 14 },
                            bodyFont: { size: 13 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Category Distribution Chart
        function updateCategoryChart() {
            const ctx = document.getElementById('categoryChart').getContext('2d');

            if (categoryChart) {
                categoryChart.destroy();
            }

            categoryChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Emergency', 'Doctor Review', 'Local Care'],
                    datasets: [{
                        data: [
                            analyticsData.categoryDistribution.RED,
                            analyticsData.categoryDistribution.YELLOW,
                            analyticsData.categoryDistribution.GREEN
                        ],
                        backgroundColor: [
                            '#f44336',
                            '#ffc107',
                            '#4caf50'
                        ],
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: { size: 12 }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ${value} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Medicine Consumption Chart
        function updateMedicineChart() {
            const ctx = document.getElementById('medicineChart').getContext('2d');

            const medicines = Object.keys(analyticsData.medicineConsumption);
            const counts = Object.values(analyticsData.medicineConsumption);

            if (medicineChart) {
                medicineChart.destroy();
            }

            medicineChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: medicines,
                    datasets: [{
                        label: 'Times Used',
                        data: counts,
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(118, 75, 162, 0.8)',
                            'rgba(76, 175, 80, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(244, 67, 54, 0.8)',
                            'rgba(33, 150, 243, 0.8)'
                        ],
                        borderColor: [
                            '#667eea',
                            '#764ba2',
                            '#4caf50',
                            '#ffc107',
                            '#f44336',
                            '#2196f3'
                        ],
                        borderWidth: 2,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 14 },
                            bodyFont: { size: 13 }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Render recent cases
        function renderRecentCases() {
            if (!analyticsData || !analyticsData.recentCases) return;

            const caseList = document.getElementById('caseList');
            const filteredCases = currentFilter === 'all' 
                ? analyticsData.recentCases 
                : analyticsData.recentCases.filter(c => c.category === currentFilter);

            if (filteredCases.length === 0) {
                caseList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ“­</div>
                        <div>No cases found in this category</div>
                    </div>
                `;
                return;
            }

            caseList.innerHTML = filteredCases.map(caseItem => {
                const timeAgo = getTimeAgo(new Date(caseItem.timestamp));
                const categoryLabel = caseItem.category === 'RED' ? 'EMERGENCY' :
                                     caseItem.category === 'YELLOW' ? 'REVIEW' : 'LOCAL CARE';
                const categoryClass = caseItem.category.toLowerCase();
                
                const medicineList = caseItem.medicines && caseItem.medicines.length > 0
                    ? `<br><strong>Medicines:</strong> ${caseItem.medicines.map(m => m.name).join(', ')}`
                    : '';

                return `
                    <div class="case-item ${categoryClass}">
                        <div class="case-header">
                            <div>
                                <span class="case-id">${caseItem.id}</span>
                                <span class="case-severity ${categoryClass}">
                                    ${categoryLabel}
                                </span>
                            </div>
                            <div class="case-time">${timeAgo}</div>
                        </div>
                        <div class="case-details">
                            <strong>Symptoms:</strong> ${caseItem.symptoms}${medicineList}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Calculate time ago
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return 'Just now';
            if (seconds < 3600) return `${Math.floor(seconds / 60)} minutes ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;
            return `${Math.floor(seconds / 86400)} days ago`;
        }

        // Filter cases
        function filterCases(category) {
            currentFilter = category;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            renderRecentCases();
        }

        // Initialize dashboard
        fetchAnalytics();

        // Auto-refresh every 30 seconds
        setInterval(fetchAnalytics, 30000);
    </script>
</body>
</html>
